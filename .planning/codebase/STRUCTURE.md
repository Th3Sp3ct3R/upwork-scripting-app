# Codebase Structure

**Analysis Date:** 2026-02-18

## Directory Layout

```
upwork_scripting_app/
├── main.py                 # FastAPI HTTP server + API endpoints
├── config.py               # Centralized configuration (keywords, budgets, limits)
├── requirements.txt        # Python dependencies
├── .env.example            # Template for .env (contains CLAUDE_API_KEY example)
├── upwork.db               # SQLite database (created at runtime)
├── .planning/
│   └── codebase/           # GSD planning documents (this directory)
├── db/
│   ├── __init__.py         # Package marker
│   ├── database.py         # SQLite connection pooling and query helpers
│   └── schema.sql          # Database schema (CREATE TABLE statements)
├── modules/
│   ├── __init__.py         # Package marker
│   ├── feed_monitor.py     # RSS feed polling and job insertion
│   ├── job_filter.py       # Budget/keyword filtering and relevance scoring
│   ├── proposal_generator.py # Claude API calls to generate proposals
│   └── sender.py           # Export approved proposals to files
├── dashboard/
│   └── index.html          # Single-page dashboard (HTML/JS, no build step)
├── exports/                # Output directory (created at runtime)
│   └── {YYYY-MM-DD}/       # Daily subdirectories
│       └── {id:04d}_{slug}.txt # Formatted proposal files
├── .git/                   # Git repository
├── .gitignore              # Excludes .env, *.db, /exports, __pycache__
├── README.md               # User-facing project overview
├── SYSTEM_OVERVIEW.md      # Detailed architecture and workflow guide
├── QUICKSTART.md           # 5-minute setup instructions
├── SETUP.md                # Full setup guide with screenshots
├── SETUP_LOCAL.md          # Local development setup
├── PROJECT_STATUS.md       # Current implementation status
└── test_system.py          # Verification script (imports, env, db tests)
```

## Directory Purposes

**Root:**
- Purpose: Project entry point, metadata, configuration
- Contains: Main server, config, environment setup, documentation
- Key files: `main.py` (entry point), `config.py` (all settings), `.env` (secrets)

**`db/`:**
- Purpose: Database abstraction layer
- Contains: SQLite initialization, connection pooling, query helpers, schema
- Key files: `database.py` (exec_query function), `schema.sql` (CREATE TABLE)
- Access pattern: All modules import `from db.database import exec_query` and call with parameterized queries

**`modules/`:**
- Purpose: Business logic pipeline phases
- Contains: Four independent modules for feed → filter → generate → send workflow
- Key files: `feed_monitor.py`, `job_filter.py`, `proposal_generator.py`, `sender.py`
- Access pattern: Each has a public function (monitor_feeds, filter_all_new_jobs, etc.) called by main.py

**`dashboard/`:**
- Purpose: Frontend UI (human review interface)
- Contains: Single HTML file with embedded CSS and JavaScript
- Key files: `index.html` (complete SPA, no build tools)
- Access pattern: Served by FastAPI at `/dashboard/index.html`, uses fetch() to call /api/* endpoints

**`exports/`:**
- Purpose: Output staging area for approved proposals
- Contains: Organized by date; one .txt file per approved proposal
- Key files: Dynamically created by `sender.py` when export_approved_proposals() called
- Structure: `/exports/2026-02-18/0001_build-rest-api.txt`, `/exports/2026-02-18/0002_python-automation.txt`
- Committed: No (in .gitignore)

**`.planning/codebase/`:**
- Purpose: GSD (Generalist Systems Developer) planning documents
- Contains: Architecture analysis, testing patterns, conventions, tech stack
- Key files: ARCHITECTURE.md, STRUCTURE.md, TESTING.md, CONVENTIONS.md (generated by /gsd:map-codebase)
- Committed: Yes (useful for future development)

## Key File Locations

**Entry Points:**

| File | Purpose | How to invoke |
|------|---------|---------------|
| `main.py` | FastAPI HTTP server | `python main.py` or `uvicorn main:app` |
| `modules/feed_monitor.py` | Poll Upwork feeds | `python modules/feed_monitor.py` or POST /api/run-cycle |
| `modules/job_filter.py` | Filter jobs | `python modules/job_filter.py` or POST /api/run-cycle |
| `modules/proposal_generator.py` | Generate proposals | `python modules/proposal_generator.py` or POST /api/run-cycle |
| `modules/sender.py` | Export approved | `python modules/sender.py` or POST /api/export-approved |
| `dashboard/index.html` | Dashboard UI | Open http://localhost:8000/dashboard/index.html |

**Configuration:**

| File | Purpose | Editing |
|------|---------|---------|
| `config.py` | Keywords, budgets, limits, API model | Edit directly (requires restart) |
| `.env` | Secrets (Claude API key) | Copy .env.example, add your key |
| `db/schema.sql` | Database structure | Only edit before first init |

**Core Logic:**

| File | Module | Key Function |
|------|--------|--------------|
| `modules/feed_monitor.py` | Feed Monitor | `monitor_feeds()` (line 66) |
| `modules/job_filter.py` | Job Filter | `filter_all_new_jobs()` (line 108) |
| `modules/proposal_generator.py` | Proposal Gen | `generate_all_pending()` (line 125) |
| `modules/sender.py` | Export | `export_approved_proposals()` (line 25) |

**Testing & Verification:**

| File | Purpose | Run with |
|------|---------|----------|
| `test_system.py` | Verify setup | `python test_system.py` |

## Naming Conventions

**Files:**

- **Python modules**: `snake_case.py` (e.g., `feed_monitor.py`, `proposal_generator.py`)
- **Database**: `upwork.db` (SQLite, created at runtime)
- **Exported proposals**: `{id:04d}_{job_slug}.txt` (zero-padded ID, slug from title)
- **Daily export dirs**: `{YYYY-MM-DD}/` (ISO format)
- **Config**: `config.py` (singular, global settings)
- **HTML dashboard**: `index.html` (simple single-page app)

**Functions & Variables:**

- **Main pipeline functions**: `monitor_feeds()`, `filter_all_new_jobs()`, `generate_all_pending()`, `export_approved_proposals()` (verb_noun pattern)
- **Helper functions**: `fetch_feed()`, `extract_job_from_entry()`, `is_budget_acceptable()`, `check_blacklist()` (descriptive, private implied by location in module)
- **Database functions**: `exec_query()`, `get_db()`, `init_db()` (verb_noun)
- **Configuration constants**: `CLAUDE_API_KEY`, `FEED_POLL_INTERVAL`, `BUDGET_FILTERS`, `KEYWORD_WHITELIST` (SCREAMING_SNAKE_CASE)
- **Logging**: `logger` (consistent across all modules)
- **API endpoints**: kebab-case in URL (`/api/run-cycle`, `/api/export-approved`, `/api/proposal/{id}/approve`)

**Classes & Types:**

- No custom classes (procedural module-based design)
- Database rows accessed as dicts (via sqlite3.Row factory)
- API models implicit (FastAPI infers from function parameters)

**Directories:**

- `modules/` (plural, contains multiple feature modules)
- `db/` (abbreviation standard for database)
- `dashboard/` (singular, specific component)
- `exports/` (plural, output directory)
- `.planning/` (dot prefix, meta/infrastructure directory)

## Where to Add New Code

**New Feature (e.g., Slack Notifications):**
- Primary code: `modules/notifications.py` (new module following pattern)
- Call from: `main.py` in relevant endpoint (e.g., POST /api/run-cycle)
- Configuration: Add to `config.py` (SLACK_WEBHOOK_URL, SLACK_ENABLED)
- Database: Add table to `db/schema.sql` if storing notification history
- Testing: Add verification to `test_system.py` if new external integration

**New Job Filter Rule:**
- Location: Modify `modules/job_filter.py` (add function like `check_experience_level()`)
- Configuration: Add keywords/thresholds to `config.py`
- Integration: Call from `filter_job()` function (line 57)
- Database: Update job.filter_reason to include new reason if filtering out

**New API Endpoint:**
- Location: Add function in `main.py` with @app.get/@app.post decorator
- Pattern: Copy existing endpoint (e.g., GET /api/jobs) and modify query
- Response: Return dict or list (FastAPI auto-converts to JSON)
- Error handling: Raise HTTPException(status_code=404) if not found

**New Dashboard Feature:**
- Location: Modify `dashboard/index.html` (add HTML, CSS, and fetch() call)
- No build step: Inline CSS in <style> and JS in <script>
- API calls: Use `const API_BASE = 'http://localhost:8000'` + fetch()
- State management: Refresh page sections after user action (e.g., loadProposals() after approve)

**New Database Table:**
- Location: Add to `db/schema.sql` (CREATE TABLE IF NOT EXISTS ...)
- Access: Query via `exec_query()` in `db/database.py` pattern
- Indexes: Add indexes for columns used in WHERE/ORDER BY (see existing pattern)
- Migration: For existing databases, would need ALTER TABLE (currently dev-only, can recreate)

**Shared Utilities:**
- Location: Create `modules/utils.py` or `modules/helpers.py`
- Imports: Other modules import via `from modules.utils import function_name`
- No monolithic utils: Keep utilities with related logic (e.g., budget parsing in job_filter.py)

## Special Directories

**`exports/` Directory:**
- Purpose: Staging area for human-readable proposal files
- Generated: Yes (created by `sender.py` when export_approved_proposals() called)
- Committed: No (in .gitignore)
- Structure: Daily subdirectories by date (e.g., `/exports/2026-02-18/`)
- Cleanup: User deletes manually or via scheduled job (not automated)

**`.git/` Directory:**
- Purpose: Git version control repository
- Generated: Yes (by `git init`)
- Committed: Partial (.git/hooks/ contains templates, actual history excluded)

**`.planning/codebase/` Directory:**
- Purpose: GSD (Generalist Systems Developer) mapping and planning documents
- Generated: Yes (by /gsd:map-codebase command)
- Committed: Yes (useful for future development context)
- Contents: ARCHITECTURE.md, STRUCTURE.md, CONVENTIONS.md, TESTING.md, CONCERNS.md (conditionally)

**Root Config Files:**
- `.env.example`: Template with example values (COMMITTED)
- `.env`: Actual secrets (NOT COMMITTED, in .gitignore)
- `.gitignore`: Excludes .env, *.db, /exports/, __pycache__, .git, .planning

## Project Statistics

- **Total Python files**: 7 (main.py, config.py, 4 modules in /modules, 1 in /db)
- **Total lines of code**: ~650 (main.py ~225, modules ~100-150 each, db/ ~50)
- **Database tables**: 3 (jobs, proposals, feed_log)
- **API endpoints**: 12 (GET /health, GET /api/stats, GET /api/jobs, GET /api/queue, etc.)
- **External dependencies**: 4 main (fastapi, anthropic, feedparser, python-dotenv)
- **Configuration options**: 20+ (keywords, budgets, model, limits, CORS origins)

---

## Development Workflow

**Starting fresh:**
```bash
cp .env.example .env       # Create secrets file
vi .env                    # Add CLAUDE_API_KEY
python main.py             # Start server (creates DB automatically)
# Dashboard opens at http://localhost:8000/dashboard/index.html
```

**Adding a feature:**
```bash
# 1. Update config.py with any new settings
# 2. Create/modify module (e.g., modules/notifications.py)
# 3. Import and call from main.py endpoint
# 4. Update dashboard/index.html if user-facing
# 5. Test via API (curl) or dashboard
```

**Debugging a phase:**
```bash
# Run phase standalone
python modules/feed_monitor.py      # Fetch debug
python modules/job_filter.py        # Filter debug
python modules/proposal_generator.py # Generate debug

# Or via API
curl -X POST http://localhost:8000/api/run-cycle
curl http://localhost:8000/api/stats
curl http://localhost:8000/api/queue
```

**Inspecting database:**
```bash
sqlite3 upwork.db
> SELECT * FROM jobs LIMIT 5;
> SELECT * FROM proposals WHERE status='pending';
> .schema                  # Show all tables
```
